{% extends "_base.html" %}
{% load mathfilters %}
{% load markdown %}
{% load fullurl %}
{% load i18n %}
{% load get_setting %}

{% block head_title %}
  {{policy.title}}
{% endblock %}

{% block custom_sm_title %}
  <meta property="og:title" content="{{policy.title}}">
  <meta property="og:description" content="{{policy.subtitle}}">
  <meta property="og:url" content="{% fullurl 'policy_item' policy_id=policy.id slug=policy.slug %}">
{% endblock %}

{% block custom_header %}
  <div class="container-fluid">
    <div class="container">
      <div class="row">
        <div class="col-6">
          <a href="/" class="go-to-index"><i class="material-icons chevron-left">chevron_left</i><span>{% trans "Return to Overview" %}</span></a>
        </div>
        {% if request.guard.policy_edit %}
        <div class="col-6 align-right">
          <a class="go-to-index" href="{% url 'policy_edit' policy_id=policy.id %}"><span>{% trans "Edit Policy" %}</span><i class="material-icons chevron-right">chevron_right</i></a>
        </div>
        {% endif %}
      </div>
      <div class="row initiative-title">
        <div class="col-12">
            <h1 class="display-4">{{policy.title}}</h1>
        </div>
      </div>
      <div class="row initiative-subtitle">
        <div class="col-12">
          <p>{{policy.subtitle}}</p>
        </div>
      </div>

      <hr/>
      {% include "initproc/blocks/meta.html" %}
      <hr/>

      {% include "initproc/blocks/variants.html" %}

      {% if request.guard.policy_review or has_reviews %}
        <div class="row initiative-moderation">
          <div class="col-12">
          {% include "fragments/moderation/moderation_index.html" %}      
          </div>
        </div>
      {% endif %}

      {% if request.guard.reason %}
        <div class="alert alert-warning">{{ request.guard.reason }}</div>
      {% endif %}

      {% if request.guard.can_be_undemocratic %}
        {% if request.guard.policy_discuss %}
          <div class="row">
            <div class="col-12">
              <h2>Undemocratic Zone</h2>
              <div class="voty-undemocratic-override-wrapper">
                  <div class="align-right">
                    <form class="action-form" action="{% url 'policy_discuss' policy_id=policy.id %}" style="display:inline" method="POST">
                      {% csrf_token %}
                      <button title="{% trans 'Force Policy into Discussion' %}" class="btn btn-danger" type="submit">
                        <i class="material-icons forward">forward</i>
                        <span>{% trans "Force Policy into Discussion" %}</span>
                      </button>
                    </form>
                  </div>  
                </div>
            </div>
          </div>
        {% endif %}
      {% endif %}

      <div class="row skip-meta">
        <div class="col-4 voty-timer-wrapper">
          {% with "PLATFORM_POLICY_STATE_DICT.DISCUSSED"|get_setting as discussed %}
            {% if policy.state == discussed %}
              <span class="skip-meta voty-timer"><i class="material-icons">schedule</i> {% trans "Time left:" %} {{policy.end_of_this_phase | timeuntil}}</span>
            {% endif %}
          {% endwith %}
          {% with "PLATFORM_POLICY_STATE_DICT.VALIDATED"|get_setting as validated %}
            {% if policy.state == validated %}
              <span class="skip-meta voty-timer"><i class="material-icons">schedule</i> {% trans "Time left:" %} {{policy.end_of_this_phase | timeuntil}}</span>
            {% endif %}
          {% endwith %}
          {% with "PLATFORM_POLICY_STATE_DICT.REJECTED"|get_setting as rejected %}
            {% if policy.state == rejected %}
              <span class="skip-meta voty-timer"><i class="material-icons">schedule</i> {% trans "Reopen:" %} {{policy.end_of_this_phase | timeuntil}}</span>
            {% endif %}
          {% endwith %}
          {% with "PLATFORM_POLICY_STATE_DICT.CHALLENGED"|get_setting as challenged %}
            {% if policy.state == challenged %}
              <span class="skip-meta voty-timer"><i class="material-icons">schedule</i> {% trans "Reopen:" %} {{policy.end_of_this_phase | timeuntil}}</span>
            {% endif %}
          {% endwith %}

        </div>
        <div class="col-8">

          {% if request.guard.policy_delete %}
          <div class="align-right">
            <form class="action-form" action="{% url 'policy_delete' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Delete Policy' %}" class="btn btn-success" type="submit">
                <i class="material-icons forward">forward</i>
                <span>{% trans "Delete Policy" %}</span>
              </button>
            </form>
          </div>
          {% endif %}

          {% if request.guard.policy_undelete %}
          <div class="align-right">
            <form class="action-form" action="{% url 'policy_undelete' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Undelete Policy into hidden status' %}" class="btn btn-success" type="submit">
                <i class="material-icons forward">forward</i>
                <span>{% trans "Undelete Policy (will be hidden)" %}</span>
              </button>
            </form>
          </div>
          {% endif %}

          {% if request.guard.policy_unhide %}
          <div class="align-right">
            <form class="action-form" action="{% url 'policy_unhide' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Unhide Policy into draft status' %}" class="btn btn-success" type="submit">
                <i class="material-icons forward">forward</i>
                <span>{% trans "Unhide Policy (set to Draft)" %}</span>
              </button>
            </form>
          </div>
          {% endif %}

          {% if request.guard.policy_apply %}
            <div class="align-right">
              <form class="action-form" action="{% url 'policy_apply' policy_id=policy.id %}" style="display:inline" method="POST">
                {% csrf_token %}
                <button title="{% trans 'Apply as Co-Initiator' %}" class="btn btn-success" type="submit">
                  <i class="material-icons forward">forward</i>
                  <span>{% trans "Apply as Co-Initiator" %}</span>
                </button>
              </form>
            </div>
          {% endif %}

          {% if request.guard.policy_stage %}
          <div class="align-right">
            <form class="action-form" action="{% url 'policy_stage' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Put policy into public draft and find co-initiators' %}" class="btn btn-success" type="submit">
                <i class="material-icons forward">forward</i>
                <span>{% trans "Stage Policy (public draft)" %}</span>
              </button>
            </form>
            <form class="action-form" action="{% url 'policy_delete' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Delete Policy' %}" class="btn btn-danger" type="submit">
                <i class="material-icons delete_outline">delete_outline</i>
              </button>
            </form>
          </div>
          {% endif %}

          {% if request.guard.policy_submit %}
          <div class="align-right">
            <form class="action-form" action="{% url 'policy_submit' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Submit Policy for validation' %}" class="btn btn-success" type="submit">
                <i class="material-icons forward">forward</i>
                <span>{% trans "Submit Policy (for validation)" %}</span>
              </button>
            </form>
            <form class="action-form" action="{% url 'policy_delete' policy_id=policy.id %}" style="display:inline" method="POST">
              {% csrf_token %}
              <button title="{% trans 'Delete Policy' %}" class="btn btn-danger" type="submit">
                <i class="material-icons delete_outline">delete_outline</i>
              </button>
            </form>
          </div>          
          {% endif %}

          {% if request.guard.policy_challenge %}
            <div class="align-right">
              <form class="action-form" action="{% url 'policy_challenge' policy_id=policy.id %}" style="display:inline" method="POST">
                {% csrf_token %}
                <button title="{% trans 'Challenge Rejection' %}" class="btn btn-success" type="submit">
                  <i class="material-icons forward">forward</i>
                  <span>{% trans "Challenge Rejection" %}</span>
                </button>
              </form>
              <form class="action-form" action="{% url 'policy_delete' policy_id=policy.id %}" style="display:inline" method="POST">
                {% csrf_token %}
                <button title="{% trans 'Delete Policy' %}" class="btn btn-danger" type="submit">
                  <i class="material-icons delete_outline">delete_outline</i>
                </button>
              </form>
            </div>    
          {% endif %}

          {% if request.guard.policy_validate %}
            {% if policy.ready_for_next_stage %}
              {% if policy.ready_to_proceed %}
                <div class="align-right">
                  <form class="action-form" action="{% url 'policy_validate' policy_id=policy.id %}" style="display:inline" method="POST">
                    {% csrf_token %}
                    <button title="{% trans 'Validate Policy to seek support' %}" class="btn btn-success" type="submit">
                      <i class="material-icons forward">forward</i>
                      <span>{% trans "Validate Policy (to seek support)" %}</span>
                    </button>
                  </form>
                </div>
              {% else %}
                <div class="align-right">
                  <form class="action-form" action="{% url 'policy_reject' policy_id=policy.id %}" style="display:inline" method="POST">
                    {% csrf_token %}
                    <button title="{% trans 'Reject Policy' %}" class="btn btn-danger" type="submit">
                      <i class="material-icons forward">forward</i>
                      <span>{% trans "Reject Policy" %}</span>
                    </button>
                  </form>
                </div>
              {% endif %}
            {% endif %}
          {% endif %}

          {% if request.guard.policy_discuss %}
            {% if policy.ready_for_next_stage %}
              <div class="align-right">
                <form class="action-form" action="{% url 'policy_discuss' policy_id=policy.id %}" style="display:inline" method="POST">
                  {% csrf_token %}
                  <button title="{% trans 'Move Policy to Discussion' %}" class="btn btn-success" type="submit">
                    <i class="material-icons forward">forward</i>
                    <span>{% trans "Move Policy to Discussion" %}</span>
                  </button>
                </form>
              </div>
            {% elif policy.ready_to_proceed %}
              <div class="align-right">
                <form class="action-form" action="{% url 'policy_close' policy_id=policy.id %}" style="display:inline" method="POST">
                  {% csrf_token %}
                  <button title="{% trans 'Close Policy' %}" class="btn btn-success" type="submit">
                    <i class="material-icons forward">forward</i>
                    <span>{% trans "Close Policy" %}</span>
                  </button>
                </form>
              </div>
            {% endif %}
          {% endif %}

          {% if request.guard.policy_invite %}
            {% with "PLATFORM_POLICY_STATE_DICT.VALIDATED"|get_setting as validated %}
              {% if policy.state == validated %}
                <div class="align-right" id="invite-supporters">
                  <a data-ajax="true" href="/policy/{{policy.id}}/invite/supporters?fragment=%23invite-supporters" class="btn btn-success">
                    <i class="material-icons forward">forward</i>
                    <span>{% trans "Invite supporters" %}</span>
                  </a>
                </div>
              {% else %}
                <div class="align-right" id="invite-initiators">
                  {% with 'initiators' as initiators %}
                    <a data-ajax="true" href="{% url 'policy_invite' policy_id=policy.id invite_type=initiators %}?fragment=%23invite-initiators" class="btn btn-success">
                      <i class="material-icons forward">forward</i>
                      <span>{% trans "Invite Co-Initiators" %}</span>
                    </a>
                  {% endwith %}
                  <form class="action-form" action="{% url 'policy_delete' policy_id=policy.id %}" style="display:inline" method="POST">
                    {% csrf_token %}
                    <button title="{% trans 'Delete Policy' %}" class="btn btn-danger" type="submit">
                      <i class="material-icons delete_outline">delete_outline</i>
                    </button>
                  </form>
                </div>
              {% endif %}
            {% endwith %}
          {% endif %}
          
          {% with "PLATFORM_POLICY_STATE_DICT.DISCUSSED"|get_setting as discussed %}
            {% if policy.state == discussed %}
              <div class="align-right voty-discussion-action-wrapper">
                <a href="#discuss" class="btn btn-success">
                  <i class="material-icons forward">forward</i>
                  <span>{% trans "Jump to discussion" %}</span>
                </a>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}

  <!--- ### START SUPPORT ### -->

  <div class="container-fluid initiators container-fluid-{{ policy.state }}">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h6 class="text-muted classification">{% trans "Initiators" %}
            {% if request.guard.policy_edit %}<span class="voty-muted-title-postfix"> ({% trans "edits require reconfirming support" %})</span>{% endif %}
            </span>
          </h6>
        </div>
      </div>
      <div class="row no-gutters avatar voty-initiator-list">
        {% for supporter in policy.initiators %}
          <div class="voty-inline-list flex-wrap">
            {% include "fragments/avatar.html" with size=80 user=supporter.user %}
            <div class="name">
              {{ supporter.user.get_full_name|default:supporter.user.username }}
            </div>
            {% with "PLATFORM_POLICY_EDIT_STATE_LIST"|get_setting as state_list %}
              {% if policy.state in state_list %}
                <div class="approval">

                  {# once a user acknowledges, he is in charge #}
                  {% if supporter.ack %}
                    {% if supporter.user == user and not supporter.first %}
                      <div class="action-box">
                        <form action="{% url 'policy_remove_support' policy_id=policy.id user_id=user.id %}" style="display:inline" method="POST">
                          {% csrf_token %}
                          <button title="{% trans 'Remove Support' %}" class="btn btn-danger" type="submit">
                            <i class="material-icons">delete_outline</i>
                          </button>
                        </form>
                      </div>
                    {% else %}
                      <span title="{% trans 'confirmed' %}" class="action-box"><i class="material-icons done">done</i></span>
                    {% endif %}

                  {# once confirmed: #}
                  {% else %}
                  
                    {# user himself can reconfirm/remove support #}
                    {% if supporter.user == user %}
                      {% if supporter.public %}
                        <div class="action-box">
                          <strong style="display:block">{% trans "Confirm now" %}</strong>
                          <form action="{% url 'policy_acknowledge_support' policy_id=policy.id user_id=user.id %}" style="display:inline" method="POST">
                            {% csrf_token %}
                            <button title="{% trans 'Support' %}" class="btn btn-warning" type="submit">
                              <i class="material-icons">done</i>
                            </button>
                          </form>
                          <form action="{% url 'policy_remove_support' policy_id=policy.id user_id=user.id %}" style="display:inline"  method="POST">
                            {% csrf_token %}
                            <button title="{% trans 'Remove Support' %}" class="btn btn-danger" type="submit">
                              <i class="material-icons">delete_outline</i>
                            </button>
                          </form>
                        </div>
                      {% else %}
                        <span title="{% trans 'unconfirmed' %}" class="action-box"><i class="material-icons warning">warning</i></span>
                      {% endif %}

                    {# ... and first initiator can confirm applications or remove incumbent initiators #}
                    {% else %}
                      {% if request.guard.invite_edit %}
                        {% if supporter.public %}
                          <div class="action-box">
                            <form action="{% url 'policy_remove_support' policy_id=policy.id user_id=supporter.user.id %}" style="display:inline"  method="POST">
                              {% csrf_token %}
                              <button title="{% trans 'Remove incumbent Initiator' %}" class="btn btn-danger" type="submit">
                                <i class="material-icons">delete_outline</i>
                              </button>
                            </form>
                          </div>
                        {% else %}
                          <div class="action-box">
                            <strong style="display:block">{% trans "Add Initiator" %}</strong>
                            <form action="{% url 'policy_acknowledge_support' policy_id=policy.id user_id=supporter.user.id %}" style="display:inline" method="POST">
                              {% csrf_token %}
                              <button title="{% trans 'Accept Co-Initiator application' %}" class="btn btn-success" type="submit">
                                <i class="material-icons">done</i>
                              </button>
                            </form>
                            <form action="{% url 'policy_remove_support' policy_id=policy.id user_id=supporter.user.id %}" style="display:inline"  method="POST">
                              {% csrf_token %}
                              <button title="{% trans 'Reject Co-Initiator application' %}" class="btn btn-danger" type="submit">
                                <i class="material-icons">delete_outline</i>
                              </button>
                            </form>
                          </div>
                        {% endif %}
                      {% else %}
                        <span title="{% trans 'unconfirmed' %}" class="action-box"><i class="material-icons warning">warning</i></span>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
            {% endwith %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% with "PLATFORM_POLICY_STATE_DICT.VALIDATED"|get_setting as validated %}
    {% if policy.state == validated %}
    <div id="cta" class="container-fluid cta">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <span class="voty-meta-content current-supporters">
              <strong>{{policy.absolute_supporters|default:0}}</strong>&nbsp;{% trans "Supporters" %}
            </span>&nbsp;
            {% if policy.absolute_supporters < policy.quorum %}
              <span class="voty-meta-content support-needed">
                ({% trans "Supporters missing to reach the Quorum:" %}&nbsp;<strong>{{policy.quorum|sub:policy.absolute_supporters}}</strong>)
              </span>
            {% elif policy.absolute_supporters == policy.quorum %}
              <span class="voty-meta-content support-needed">
                ({% trans "This Policy has reached the Quorum" %}!)
              </span>
            {% else %}
              <span class="voty-meta-content support-needed">
                ({% trans "This Policy has reached the Quorum" %} {% trans "and in addition " %} 
                  <strong>{{policy.absolute_supporters|sub:policy.quorum}}</strong>&nbsp;{% trans "Supporters" %}.)
              </span>
            {% endif %}
            <div class="progress">
              <div class="progress-bar bg-support" role="progressbar" style="width: {% if policy.relative_support <= 100 %}{{policy.relative_support|floatformat:"0"}}{% else %}100{% endif %}%;" aria-valuenow="{{policy.absolute_supporters}}" aria-valuemin="0" aria-valuemax="{{policy.quorum}}"></div>
            </div>
  
            {% if has_supported %}
              <span class="voty-meta-content support supported-by">
                {% trans "You are supporting this Policy!" %}
              </span>
              {% if not has_initiated %}
                <div class="voty-policy-remove-support-wrapper">
                  <form action="{% url 'policy_refrain' policy_id=policy.id %}" method="GET">
                    <button class="btn bg-support" type="submit">
                      {% trans "Remove support" %}
                    </button>
                  </form>
                </div>
              {% endif %}
            {% else %}
              <form action="{% url 'policy_support' policy_id=policy.id %}" method="GET">
                <button class="btn bg-support" type="submit">
                  {% trans "Support this Policy" %}
                </button>
                <div class="form-check">
                  <label class="form-check-label text-muted">
                    <input type="checkbox" class="form-check-input" name="public">
                    {% trans "Show support publicly" %}
                  </label>
                </div>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  {% endwith %}

  <div id="initiative-text" class="container-fluid initiative-single">
    <div class="container">
      <div class="row">
        <div class="col">
          <h6 class="text-muted classification">{% trans "Policy Text" %}
            {% if policy.versions.count > 1 %}
              <a href="{% url 'policy_history' policy_id=policy.id slug=policy.slug version_id=policy.versions.1.id %}" data-ajax="true" class="voty-muted-title-postfix">({% trans "View modification history" %}
                <span class="voty-muted-title-postix-badge"><span class="material-icons history">history</span> {{ policy.versions.count }}</span>)
              </a>
            {% endif %}
          </h6>
        </div>
      </div>

      {% include "initproc/blocks/policy_content.html" %}
    </div>
  </div>

  {% if policy.show_debate %}
    {% with "PLATFORM_POLICY_STATE_DICT.DISCUSSED"|get_setting as discussed %}
      <div id="discuss" class="container-fluid cta {% if not policy.state == discussed %}closed{% endif %}">
        {% include "fragments/discussion/discussion_index.html" %}
      </div>
    {% endwith %}
  {% endif %}

  {% with "PLATFORM_POLICY_STATE_DICT.STAGED"|get_setting as staged %}
    {% if policy.state == staged %}
      <div id="discuss" class="container-fluid cta">
        {% include "fragments/discussion/discussion_index.html" %} 
      </div>
    {% endif %}
  {% endwith %}


  {% if policy.show_supporters %}
  <div class="container-fluid show-supporters">
    <div class="container">

      {% if policy.public_supporters.count %}
        <div class="row">
          <div class="col-12">
            <h2>{% trans "Supporters" %}</h2>
            <div class="d-flex flex-wrap avatar">
              {% for supporter in policy.public_supporters.all %} 
                <div class="text-center initiator">
                  {% include "fragments/avatar.html" with user=supporter.user %}
                  <div class="name">
                    {{ supporter.user.get_full_name|default:supporter.user.username }}<br/>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
  
    </div>
  </div>
  {% endif %}

  <!--- ### END SUPPORT ### -->
  
{% endblock %}

{% block body-javascript %} {{ block.super }}
<script type="text/javascript">
// Initialize Tooltips
$(document).ready(function () {
  //$(function () {
    $('[data-toggle="tooltip"]').tooltip();
  //});
});
</script>
{% endblock %}


